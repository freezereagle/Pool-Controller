<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Controller</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header Bar -->
    <header class="header">
        <div class="header-left">
            <i class="mdi mdi-pool"></i>
            <span>Pool Controller</span>
            <span class="build-info">__BUILD_TIMESTAMP__</span>
        </div>
        <div class="header-right">
            <button class="icon-btn" id="refresh-btn" onclick="refreshAll()" title="Refresh"><i class="mdi mdi-refresh"></i></button>
            <button class="icon-btn" id="dark-mode-toggle" onclick="toggleDarkMode()" title="Theme"><i class="mdi mdi-theme-light-dark"></i></button>
            <button class="icon-btn" onclick="toggleSettings()" title="Settings"><i class="mdi mdi-cog"></i></button>
            <div id="connection-status" class="conn-badge offline" onclick="toggleSettings()">
                <i class="mdi mdi-wifi-off"></i> Offline
            </div>
        </div>
    </header>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="settings-overlay hidden">
        <div class="settings-panel">
            <div class="settings-head">
                <span><i class="mdi mdi-cog"></i> Settings</span>
                <button class="icon-btn" onclick="toggleSettings()"><i class="mdi mdi-close"></i></button>
            </div>
            <div class="settings-body">
                <div class="form-row">
                    <label>Host</label>
                    <input type="text" id="host" value="pool-controller.local">
                </div>
                <div class="form-row">
                    <label>Port</label>
                    <input type="number" id="port" value="80">
                </div>
                <div class="form-row">
                    <label>Username</label>
                    <input type="text" id="username" placeholder="optional">
                </div>
                <div class="form-row">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="optional">
                </div>
                <div class="settings-btns">
                    <button id="connect-btn" class="btn primary">Connect</button>
                    <button id="disconnect-btn" class="btn" disabled>Disconnect</button>
                </div>
                <div class="settings-section">
                    <div class="form-row">
                        <label>Auto-Refresh</label>
                        <label class="toggle"><input type="checkbox" id="auto-refresh-toggle" onchange="toggleAutoRefresh()"><span class="tog-slider"></span></label>
                    </div>
                    <div class="form-row">
                        <label>Interval (s)</label>
                        <input type="number" id="refresh-interval" value="5" min="1" max="60" style="width:60px">
                    </div>
                </div>
                <div class="settings-section">
                    <div class="info-line"><span>ESPHome</span><span id="esphome-version">-</span></div>
                    <div class="info-line"><span>SSID</span><span id="wifi-ssid">-</span></div>
                    <div class="info-line"><span>IP</span><span id="wifi-ip">-</span></div>
                    <div class="info-line"><span>Signal</span><span id="wifi-signal">-</span></div>
                </div>
                <div class="settings-section">
                    <button class="btn danger" onclick="resetAllSettings()"><i class="mdi mdi-delete"></i> Reset All Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline State -->
    <main id="offline-state" class="offline-state">
        <i class="mdi mdi-pool"></i>
        <p>Connect to your pool controller</p>
        <button class="btn primary" onclick="toggleSettings()"><i class="mdi mdi-cog"></i> Configure</button>
    </main>

    <!-- Dashboard -->
    <main id="dashboard" class="dashboard hidden">
        <!-- Alert Banner -->
        <div id="alarm-banner" class="alarm-banner hidden">
            <i class="mdi mdi-alert"></i>
            <span id="alarm-message">Alert</span>
            <button onclick="dismissAlarm()"><i class="mdi mdi-close"></i></button>
        </div>

        <!-- Top Stats Row -->
        <div class="stats-row">
            <div class="stat water"><i class="mdi mdi-pool-thermometer"></i><span id="pool-temp-f">--</span><small>Pool</small></div>
            <div class="stat air"><i class="mdi mdi-thermometer"></i><span id="air-temp-f">--</span><small>Air</small></div>
            <div class="stat pump" id="pump-stat"><i class="mdi mdi-pump"></i><span id="pump-rpm">--</span><small>RPM</small></div>
            <div class="stat power"><i class="mdi mdi-flash"></i><span id="pump-power">--</span><small>Watts</small></div>
            <div class="stat flow"><i class="mdi mdi-water-pump"></i><span id="pump-flow">--</span><small>mÂ³/h</small></div>
            <div class="stat salt"><i class="mdi mdi-flask-outline"></i><span id="salt-level">--</span><small>Salt</small></div>
            <div class="stat chlor-temp"><i class="mdi mdi-thermometer-water"></i><span id="chlor-temp">--</span><small>SWG</small></div>
        </div>

        <!-- Quick Controls -->
        <div class="quick-row">
            <button class="qc-btn" id="qc-pump" onclick="toggleQuickPump()"><i class="mdi mdi-pump"></i>Pump<span class="qc-st" id="qc-pump-status">OFF</span></button>
            <button class="qc-btn" id="qc-light" onclick="toggleSwitch('pool_light', document.getElementById('switch-pool-light'))"><i class="mdi mdi-lightbulb"></i>Light<span class="qc-st" id="qc-light-status">OFF</span></button>
            <button class="qc-btn" id="qc-waterfall" onclick="toggleSwitch('waterfall', document.getElementById('switch-waterfall'))"><i class="mdi mdi-waves"></i>Waterfall<span class="qc-st" id="qc-waterfall-status">OFF</span></button>
            <button class="qc-btn" id="qc-schedule" onclick="toggleSwitch('auto_schedule', document.getElementById('switch-auto-schedule'))"><i class="mdi mdi-calendar-clock"></i>Schedule<span class="qc-st" id="qc-schedule-status">OFF</span></button>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Pump Status -->
            <section class="card" draggable="true" data-card-id="pump">
                <div class="card-head"><span><i class="mdi mdi-pump"></i> Pump Status</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="card-grid cols2">
                    <div class="kv"><span>Running</span><span id="pump-running" class="pill">-</span></div>
                    <div class="kv"><span>Status</span><span id="pump-status" class="pill">-</span></div>
                    <div class="kv"><span>Pressure</span><span id="pump-pressure">-</span></div>
                    <div class="kv"><span>Program</span><span id="pump-program">-</span></div>
                    <div class="kv"><span>Time Left</span><span id="time-remaining">-</span></div>
                    <div class="kv"><span>Clock</span><span id="pump-clock-formatted">-</span></div>
                    <div class="kv"><span>Schedule</span><span id="current-schedule">-</span></div>
                </div>
            </section>

            <!-- Mode + Light Stack -->
            <div class="card-stack" data-stack-id="mode-light">
                <!-- Pump Mode -->
                <section class="card narrow" draggable="true" data-card-id="mode">
                    <div class="card-head"><span><i class="mdi mdi-cog-transfer"></i> Speed Mode</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                    <div class="mode-row">
                        <span class="mode-val" id="current-mode">-</span>
                        <select id="mode-select" class="sel" onchange="setPumpMode()">
                            <option value="">Set...</option>
                            <option value="Auto">Auto</option>
                            <option value="Off">Off</option>
                            <option value="Speed 1">Speed 1</option>
                            <option value="Speed 2">Speed 2</option>
                            <option value="Speed 3">Speed 3</option>
                            <option value="Speed 4">Speed 4</option>
                            <option value="Speed 5">Speed 5</option>
                        </select>
                </div>
            </section>

            <!-- Pool Light -->
            <section class="card narrow" draggable="true" data-card-id="light">
                <div class="card-head"><span><i class="mdi mdi-lightbulb"></i> Light</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="light-row">
                    <button id="switch-pool-light" class="tog-btn off" onclick="toggleSwitch('pool_light', this)">OFF</button>
                    <select id="light-mode-select" class="sel" onchange="setLightMode()">
                        <option value="">Mode...</option>
                        <option value="SAm (Color Sync)">SAm</option>
                        <option value="Party">Party</option>
                        <option value="Romance">Romance</option>
                        <option value="Caribbean">Caribbean</option>
                        <option value="American">American</option>
                        <option value="Sunset">Sunset</option>
                        <option value="Royalty">Royalty</option>
                        <option value="Blue">Blue</option>
                        <option value="Green">Green</option>
                        <option value="Red">Red</option>
                        <option value="White">White</option>
                        <option value="Magenta">Magenta</option>
                        <option value="Hold">Hold</option>
                        <option value="Recall">Recall</option>
                    </select>
                    <span id="current-light-mode" class="mode-badge">-</span>
                </div>
            </section>
            </div>

            <!-- Switches -->
            <section class="card narrow" draggable="true" data-card-id="switches">
                <div class="card-head"><span><i class="mdi mdi-toggle-switch"></i> Switches</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="switch-grid">
                    <div class="sw"><span>Waterfall</span><button id="switch-waterfall" class="tog-btn off" onclick="toggleSwitch('waterfall', this)">OFF</button></div>
                    <div class="sw"><span>WF Auto</span><button id="switch-waterfall-auto" class="tog-btn off" onclick="toggleSwitch('waterfall__auto_', this)">OFF</button></div>
                    <div class="sw"><span>Schedule</span><button id="switch-auto-schedule" class="tog-btn off" onclick="toggleSwitch('auto_schedule', this)">OFF</button></div>
                    <div class="sw"><span>Off</span><button id="switch-off" class="tog-btn off" onclick="toggleSwitch('off', this)">OFF</button></div>
                </div>
            </section>

            <!-- Chlorinator -->
            <section class="card third" draggable="true" data-card-id="chlorinator">
                <div class="card-head"><span><i class="mdi mdi-flask"></i> Chlorinator</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="card-grid cols2">
                    <div class="kv"><span>Temp</span><span id="solar-temp-f">-</span></div>
                    <div class="kv"><span>Status</span><span id="chlorinator-status">-</span></div>
                    <div class="kv"><span>Error</span><span id="chlorinator-error">-</span></div>
                    <div class="kv"><span>Output</span><span id="chlorinator-output">-</span></div>
                    <div class="kv"><span>Version</span><span id="chlorinator-version">-</span></div>
                    <div class="kv"><span>Salt</span><span id="salt-level">-</span></div>
                </div>
                <div class="chlor-ctrl-row">
                    <input type="range" id="chlorine-slider" min="0" max="100" value="50">
                    <span class="sl-val"><span id="chlorine-value">50</span>%</span>
                    <button class="btn primary sm" onclick="setChlorineOutput()">Set</button>
                </div>
                <div class="sw-row">
                    <span>Takeover</span>
                    <button id="switch-takeover" class="tog-btn off" onclick="toggleSwitch('takeover_mode', this)">OFF</button>
                </div>
            </section>

            <!-- Alarms -->
            <section class="card narrow" draggable="true" data-card-id="alarms">
                <div class="card-head"><span><i class="mdi mdi-alert"></i> IChlor Alarms</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="alarm-grid">
                    <div class="alm" id="alarm-no-flow"><i class="mdi mdi-water-off"></i>No Flow</div>
                    <div class="alm" id="alarm-low-salt"><i class="mdi mdi-minus-circle"></i>Low Salt</div>
                    <div class="alm" id="alarm-high-salt"><i class="mdi mdi-plus-circle"></i>High Salt</div>
                    <div class="alm" id="alarm-clean-cell"><i class="mdi mdi-broom"></i>Clean Cell</div>
                    <div class="alm" id="alarm-high-current"><i class="mdi mdi-flash"></i>High Curr</div>
                    <div class="alm" id="alarm-low-voltage"><i class="mdi mdi-battery-low"></i>Low Volt</div>
                    <div class="alm" id="alarm-low-temp"><i class="mdi mdi-snowflake"></i>Low Temp</div>
                    <div class="alm" id="alarm-check-pcb"><i class="mdi mdi-chip"></i>Check PCB</div>
                </div>
            </section>

            <!-- Schedule Table -->
            <section class="card third" draggable="true" data-card-id="schedule">
                <div class="card-head"><span><i class="mdi mdi-calendar-clock"></i> Schedule</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <table class="sched-tbl">
                    <thead><tr><th></th><th>Start</th><th>Speed</th><th>RPM</th><th>WF</th></tr></thead>
                    <tbody>
                        <tr><td id="schedule-1-status-tbl">-</td><td class="ed" id="schedule-1-start-tbl" onclick="editScheduleStart(1)">-</td><td class="ed" id="schedule-1-speed-tbl" onclick="editScheduleSpeed(1)">-</td><td id="schedule-1-rpm-tbl">-</td><td><span id="schedule-1-waterfall-tbl" class="wf-badge ed" onclick="toggleScheduleWaterfall(1)">-</span></td></tr>
                        <tr><td id="schedule-2-status-tbl">-</td><td class="ed" id="schedule-2-start-tbl" onclick="editScheduleStart(2)">-</td><td class="ed" id="schedule-2-speed-tbl" onclick="editScheduleSpeed(2)">-</td><td id="schedule-2-rpm-tbl">-</td><td><span id="schedule-2-waterfall-tbl" class="wf-badge ed" onclick="toggleScheduleWaterfall(2)">-</span></td></tr>
                        <tr><td id="schedule-3-status-tbl">-</td><td class="ed" id="schedule-3-start-tbl" onclick="editScheduleStart(3)">-</td><td class="ed" id="schedule-3-speed-tbl" onclick="editScheduleSpeed(3)">-</td><td id="schedule-3-rpm-tbl">-</td><td><span id="schedule-3-waterfall-tbl" class="wf-badge ed" onclick="toggleScheduleWaterfall(3)">-</span></td></tr>
                        <tr><td id="schedule-4-status-tbl">-</td><td class="ed" id="schedule-4-start-tbl" onclick="editScheduleStart(4)">-</td><td class="ed" id="schedule-4-speed-tbl" onclick="editScheduleSpeed(4)">-</td><td id="schedule-4-rpm-tbl">-</td><td><span id="schedule-4-waterfall-tbl" class="wf-badge ed" onclick="toggleScheduleWaterfall(4)">-</span></td></tr>
                        <tr><td id="schedule-5-status-tbl">-</td><td class="ed" id="schedule-5-start-tbl" onclick="editScheduleStart(5)">-</td><td class="ed" id="schedule-5-speed-tbl" onclick="editScheduleSpeed(5)">-</td><td id="schedule-5-rpm-tbl">-</td><td><span id="schedule-5-waterfall-tbl" class="wf-badge ed" onclick="toggleScheduleWaterfall(5)">-</span></td></tr>
                    </tbody>
                    <tfoot><tr><td id="schedule-off-status-tbl">OFF</td><td class="ed" id="pump-end-time-tbl" onclick="editPumpEndTime()">-</td><td colspan="3" class="foot-lbl">End Time</td></tr></tfoot>
                </table>
            </section>

            <!-- Pump Speeds -->
            <section class="card third" draggable="true" data-card-id="speeds">
                <div class="card-head"><span><i class="mdi mdi-speedometer"></i> Speed Presets</span><button class="card-width-btn" onclick="cycleCardWidth(this)" title="Change width"><i class="mdi mdi-arrow-expand-horizontal"></i></button><i class="mdi mdi-drag drag-handle"></i></div>
                <div class="speed-row">
                    <div class="spd"><label>S1</label><div class="spd-inp"><button onclick="adjustSpeed(1,-50)">-</button><input type="number" id="speed-1" value="1500"><button onclick="adjustSpeed(1,50)">+</button></div><button class="btn sm" onclick="setPumpSpeed(1)">Set</button></div>
                    <div class="spd"><label>S2</label><div class="spd-inp"><button onclick="adjustSpeed(2,-50)">-</button><input type="number" id="speed-2" value="2200"><button onclick="adjustSpeed(2,50)">+</button></div><button class="btn sm" onclick="setPumpSpeed(2)">Set</button></div>
                    <div class="spd"><label>S3</label><div class="spd-inp"><button onclick="adjustSpeed(3,-50)">-</button><input type="number" id="speed-3" value="2800"><button onclick="adjustSpeed(3,50)">+</button></div><button class="btn sm" onclick="setPumpSpeed(3)">Set</button></div>
                    <div class="spd"><label>S4</label><div class="spd-inp"><button onclick="adjustSpeed(4,-50)">-</button><input type="number" id="speed-4" value="3200"><button onclick="adjustSpeed(4,50)">+</button></div><button class="btn sm" onclick="setPumpSpeed(4)">Set</button></div>
                    <div class="spd"><label>S5</label><div class="spd-inp"><button onclick="adjustSpeed(5,-50)">-</button><input type="number" id="speed-5" value="3450"><button onclick="adjustSpeed(5,50)">+</button></div><button class="btn sm" onclick="setPumpSpeed(5)">Set</button></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="schedule-time-popup" class="modal hidden">
        <div class="modal-box">
            <div class="modal-head">Edit Start Time<button onclick="closeScheduleTimePopup()"><i class="mdi mdi-close"></i></button></div>
            <input type="time" id="schedule-time-input">
            <div class="modal-btns"><button class="btn" onclick="closeScheduleTimePopup()">Cancel</button><button class="btn primary" onclick="saveScheduleTime()">Save</button></div>
        </div>
    </div>
    <div id="schedule-speed-popup" class="modal hidden">
        <div class="modal-box">
            <div class="modal-head">Edit Speed<button onclick="closeScheduleSpeedPopup()"><i class="mdi mdi-close"></i></button></div>
            <select id="schedule-speed-select" class="sel"><option value="Off">Off</option><option value="Speed 1">Speed 1</option><option value="Speed 2">Speed 2</option><option value="Speed 3">Speed 3</option><option value="Speed 4">Speed 4</option><option value="Speed 5">Speed 5</option></select>
            <div class="modal-btns"><button class="btn" onclick="closeScheduleSpeedPopup()">Cancel</button><button class="btn primary" onclick="saveScheduleSpeed()">Save</button></div>
        </div>
    </div>
    <div id="pump-end-time-popup" class="modal hidden">
        <div class="modal-box">
            <div class="modal-head">Edit End Time<button onclick="closePumpEndTimePopup()"><i class="mdi mdi-close"></i></button></div>
            <input type="time" id="pump-end-time-input">
            <div class="modal-btns"><button class="btn" onclick="closePumpEndTimePopup()">Cancel</button><button class="btn primary" onclick="savePumpEndTime()">Save</button></div>
        </div>
    </div>

    <!-- Hidden compat elements -->
    <div style="display:none">
        <div id="configuration-section"></div><div id="temperatures-section"></div><div id="schedules-section"><div id="schedule-1-status"></div><div id="schedule-2-status"></div><div id="schedule-3-status"></div><div id="schedule-4-status"></div><div id="schedule-5-status"></div><div id="schedule-off-status"></div><input id="schedule-1-time"><input id="schedule-2-time"><input id="schedule-3-time"><input id="schedule-4-time"><input id="schedule-5-time"><select id="schedule-1-speed"></select><select id="schedule-2-speed"></select><select id="schedule-3-speed"></select><select id="schedule-4-speed"></select><select id="schedule-5-speed"></select><input type="checkbox" id="schedule-1-waterfall"><input type="checkbox" id="schedule-2-waterfall"><input type="checkbox" id="schedule-3-waterfall"><input type="checkbox" id="schedule-4-waterfall"><input type="checkbox" id="schedule-5-waterfall"></div><div id="maintenance-section"></div><div id="auto-refresh-section"></div><div id="system-section"></div><div id="pump-status-section"></div><div id="pump-mode-section"></div><div id="pool-light-section"></div><div id="chlorinator-section"></div><div id="alarms-section"></div><div id="switches-section"></div><div id="schedule-overview-section"></div><div id="pump-speeds-section"></div><div id="quick-controls-section"></div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
